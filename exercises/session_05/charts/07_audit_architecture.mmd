%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#fff3e0', 'primaryTextColor': '#e65100', 'primaryBorderColor': '#f57c00', 'lineColor': '#f57c00', 'secondaryColor': '#e3f2fd', 'tertiaryColor': '#f3e5f5'}}}%%
flowchart TB
    subgraph Request["Incoming Request"]
        REQ["User Query +<br/>Correlation ID"]
    end

    subgraph Pipeline["SecureDevHub Pipeline"]
        direction TB
        PII["PII Check"]
        INJ["Injection Check"]
        AGENT["DevHub Agent"]
        PII --> INJ --> AGENT
    end

    subgraph AuditLog["Audit Logger (SQLite)"]
        direction TB
        subgraph Record["Audit Record"]
            direction LR
            F1["timestamp"]
            F2["correlation_id"]
            F3["user_query"]
            F4["pii_detected"]
            F5["injection_blocked"]
            F6["tools_called"]
            F7["response_length"]
            F8["latency_ms"]
        end
        DB["Append-Only<br/>SQLite Table"]
        Record --> DB
    end

    subgraph Compliance["Compliance Queries"]
        direction LR
        C1["GDPR: Data<br/>Subject Report"]
        C2["SOC 2: Security<br/>Event Summary"]
        C3["HIPAA: Access<br/>Audit Trail"]
    end

    REQ --> Pipeline
    Pipeline --> AuditLog
    DB --> Compliance

    style AuditLog fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    style Pipeline fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    style Compliance fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    style DB fill:#ffe0b2,stroke:#ef6c00,stroke-width:3px
    style C1 fill:#e8eaf6,stroke:#3f51b5
    style C2 fill:#e8eaf6,stroke:#3f51b5
    style C3 fill:#e8eaf6,stroke:#3f51b5
