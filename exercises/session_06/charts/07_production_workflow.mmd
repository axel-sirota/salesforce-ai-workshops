%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#e1f5fe', 'primaryTextColor': '#01579b', 'primaryBorderColor': '#0288d1', 'lineColor': '#0288d1', 'secondaryColor': '#fff3e0', 'tertiaryColor': '#f3e5f5'}}}%%
flowchart LR
    subgraph Dev["Step 1: Develop"]
        direction TB
        D1["Write new prompt"]
        D2["Run TDD cycle<br/>(red/green/refactor)"]
        D1 --> D2
    end

    subgraph Test["Step 2: Test"]
        direction TB
        T1["Full regression<br/>suite"]
        T2{"All metrics<br/>above<br/>threshold?"}
        T1 --> T2
    end

    subgraph Canary["Step 3: Canary"]
        direction TB
        C1["Deploy to 10%<br/>of traffic"]
        C2["Monitor metrics<br/>in Langfuse"]
        C3{"Quality<br/>holds?"}
        C1 --> C2 --> C3
    end

    subgraph Promote["Step 4: Promote"]
        direction TB
        P1["Set alias<br/>stable â†’ new version"]
        P2["100% traffic"]
        P1 --> P2
    end

    subgraph Monitor["Step 5: Monitor"]
        direction TB
        M1["Track scores<br/>over time"]
        M2["Alert if score<br/>drops below<br/>threshold"]
        M1 --> M2
    end

    Dev --> Test
    T2 -->|"YES"| Canary
    T2 -->|"NO"| Dev
    C3 -->|"YES"| Promote
    C3 -->|"NO"| ROLLBACK["Rollback to<br/>previous version"]
    Promote --> Monitor

    style Dev fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    style Test fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    style Canary fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    style Promote fill:#e8f5e9,stroke:#388e3c,stroke-width:2px
    style Monitor fill:#e8eaf6,stroke:#3f51b5,stroke-width:2px
    style ROLLBACK fill:#ffcdd2,stroke:#c62828,stroke-width:2px
