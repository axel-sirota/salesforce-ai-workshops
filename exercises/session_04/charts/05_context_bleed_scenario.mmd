%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#e1f5fe', 'primaryTextColor': '#01579b', 'primaryBorderColor': '#0288d1', 'lineColor': '#0288d1', 'secondaryColor': '#fff3e0', 'tertiaryColor': '#f3e5f5'}}}%%
flowchart TB
    subgraph Turn1["Turn 1: Cancellation Query"]
        direction LR
        U1["User:<br/>'Cancel order #12345'"]
        C1["Context stored:<br/>cancel, order, contact"]
        T1["Tool: find_owner"]
        R1["Response:<br/>'Contact Sarah Chen'"]

        U1 --> C1
        C1 --> T1
        T1 --> R1
    end

    subgraph Turn2["Turn 2: Status Query"]
        direction LR
        U2["User:<br/>'Status of #67890?'"]
        C2["Context includes:<br/>CANCEL from Turn 1"]
        T2["Tool: find_owner<br/>WRONG!"]
        R2["Response:<br/>'Contact Sarah...'"]

        U2 --> C2
        C2 --> T2
        T2 --> R2
    end

    subgraph Expected["Expected Behavior"]
        E1["Tool: check_status"]
        E2["Response:<br/>'Order #67890 is shipped'"]
        E1 --> E2
    end

    C1 -.->|"Context<br/>BLEEDS"| C2
    T2 -.->|"Should be"| E1

    subgraph RootCause["Root Cause"]
        RC["'cancel' keyword from Turn 1<br/>influenced model to select<br/>find_owner instead of check_status"]
    end

    C2 --> RootCause

    style C2 fill:#ffcdd2,stroke:#c62828,stroke-width:3px
    style T2 fill:#ffcdd2,stroke:#c62828,stroke-width:3px
    style E1 fill:#c8e6c9,stroke:#2e7d32,stroke-width:2px
    style RootCause fill:#fff9c4,stroke:#f9a825,stroke-width:2px
